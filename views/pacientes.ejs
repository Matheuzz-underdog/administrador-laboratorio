<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css" />
    <title>Gestion de Pacientes</title>
</head>
<body>
    <%- include('partials/_header') %>

  <h1>Gestion de Pacientes</h1>
  <hr>

    <div id="modal-fondo"
        onclick="cerrarModal()"
        style="display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background-color:rgba(0,0,0,0.45);">

    <div onclick="event.stopPropagation()"
        style="position:absolute;
            top:50%; left:50%;
            transform:translate(-50%, -50%);
            background:white;
            border:2px solid black;
            padding:30px 40px;
            min-width:280px;
            max-width:420px;
            text-align:center;">

    <p id="texto-modal" style="font-size:1.1em; margin:0 0 18px 0;"></p>
    <small>click para cerrar</small>

    </div>
    </div>

    <h2>Lista de Pacientes</h2>

    <% if (pacientes && pacientes.length > 0) { %>
    <table border="1" cellpadding="6" cellspacing="0">
        <thead>
        <tr>
            <th>Cedula</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Sexo</th>
            <th>Fecha Nacimiento</th>
            <th>Telefono</th>
            <th>Email</th>
            <th>Direccion</th>
            <th>Fecha Registro</th>
        </tr>
    </thead>
      <tbody>
        <% pacientes.forEach(function(p) { %>
          <tr>
            <td><%= p.cedula %></td>
            <td><%= p.nombre %></td>
            <td><%= p.apellido %></td>
            <td><%= p.sexo %></td>
            <td><%= p.fechaNacimiento ? new Date(p.fechaNacimiento).toLocaleDateString('es-VE') : '-' %></td>
            <td><%= p.telefono || '-' %></td>
            <td><%= p.email || '-' %></td>
            <td><%= p.direccion || '-' %></td>
            <td><%= p.fechaRegistro ? new Date(p.fechaRegistro).toLocaleString('es-VE') : '-' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p>No hay pacientes registrados.</p>
  <% } %>

  <hr>

  <h2>Registrar Paciente</h2>

  <form id="form-crear">
    <table>
      <tr>
        <td><label for="c-cedula">Cedula:</label></td>
        <td><input type="text" id="c-cedula" placeholder="V-12345678"></td>
      </tr>
      <tr>
        <td><label for="c-nombre">Nombre:</label></td>
        <td><input type="text" id="c-nombre"></td>
      </tr>
      <tr>
        <td><label for="c-apellido">Apellido:</label></td>
        <td><input type="text" id="c-apellido"></td>
      </tr>
      <tr>
        <td><label for="c-sexo">Sexo:</label></td>
        <td>
          <select id="c-sexo">
            <option value="">-- Seleccione --</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label for="c-fecha">Fecha Nacimiento:</label></td>
        <td><input type="date" id="c-fecha"></td>
      </tr>
      <tr>
        <td><label for="c-telefono">Telefono:</label></td>
        <td><input type="text" id="c-telefono" placeholder="0412-1234567"></td>
      </tr>
      <tr>
        <td><label for="c-email">Email (opcional):</label></td>
        <td><input type="email" id="c-email"></td>
      </tr>
      <tr>
        <td><label for="c-direccion">Direccion:</label></td>
        <td><input type="text" id="c-direccion"></td>
      </tr>
    </table>
    <br>
    <button type="button" onclick="crearPaciente()">Registrar</button>
  </form>

  <hr>

  <h2>Buscar Paciente por Cedula</h2>

  <label for="b-cedula">Cedula:</label>
  <input type="text" id="b-cedula" placeholder="V-12345678">
  <button type="button" onclick="buscarPaciente()">Buscar</button>

  <div id="resultado-busqueda"></div>

  <hr>

  <h2>Buscar Paciente por ID</h2>
  <p>Ingrese los primeros 5 caracteres del ID del paciente.</p>

  <label for="bid-id">ID:</label>
  <input type="text" id="bid-id" placeholder="a1b2c" maxlength="5">
  <button type="button" onclick="buscarPorId()">Buscar</button>

  <div id="resultado-busqueda-id"></div>

  <hr>

  <h2>Actualizar Paciente</h2>
  <p>Solo complete los campos que desea cambiar. La cedula actual es obligatoria.</p>

  <table>
    <tr>
      <td><label for="a-cedula-actual">Cedula actual:</label></td>
      <td><input type="text" id="a-cedula-actual" placeholder="V-12345678"></td>
    </tr>
    <tr>
      <td><label for="a-cedula-nueva">Nueva cedula (opcional):</label></td>
      <td><input type="text" id="a-cedula-nueva" placeholder="V-12345678"></td>
    </tr>
    <tr>
      <td><label for="a-nombre">Nombre:</label></td>
      <td><input type="text" id="a-nombre"></td>
    </tr>
    <tr>
      <td><label for="a-apellido">Apellido:</label></td>
      <td><input type="text" id="a-apellido"></td>
    </tr>
    <tr>
      <td><label for="a-sexo">Sexo:</label></td>
      <td>
        <select id="a-sexo">
          <option value="">-- Sin cambio --</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label for="a-fecha">Fecha Nacimiento:</label></td>
      <td><input type="date" id="a-fecha"></td>
    </tr>
    <tr>
      <td><label for="a-telefono">Telefono:</label></td>
      <td><input type="text" id="a-telefono"></td>
    </tr>
    <tr>
      <td><label for="a-email">Email:</label></td>
      <td><input type="email" id="a-email"></td>
    </tr>
    <tr>
      <td><label for="a-direccion">Direccion:</label></td>
      <td><input type="text" id="a-direccion"></td>
    </tr>
  </table>
  <br>
  <button type="button" onclick="actualizarPaciente()">Actualizar</button>

  <hr>

  <h2>Eliminar Paciente</h2>

  <label for="e-cedula">Cedula:</label>
  <input type="text" id="e-cedula" placeholder="V-12345678">
  <button type="button" onclick="eliminarPaciente()">Eliminar</button>

  <hr>

  <script>

    // recargarAlCerrar indica si al cerrar el modal se debe recargar la pagina
    let recargarAlCerrar = false;

    // Abre el modal con el mensaje. Si recargar=true, al cerrarlo se recarga la pagina.
    function mostrarMensaje(texto, exito, recargar) {
      recargarAlCerrar = recargar || false;
      const parrafo = document.getElementById('texto-modal');
      parrafo.textContent = texto;
      parrafo.style.color = exito ? 'green' : 'red';
      document.getElementById('modal-fondo').style.display = 'block';
    }

    // recarga si corresponde
    function cerrarModal() {
      document.getElementById('modal-fondo').style.display = 'none';
      if (recargarAlCerrar) {
        location.reload();
      }
    }

    //CREAR
    async function crearPaciente() {
      const datos = {
        cedula:          document.getElementById('c-cedula').value.trim(),
        nombre:          document.getElementById('c-nombre').value.trim(),
        apellido:        document.getElementById('c-apellido').value.trim(),
        sexo:            document.getElementById('c-sexo').value,
        fechaNacimiento: document.getElementById('c-fecha').value,
        telefono:        document.getElementById('c-telefono').value.trim(),
        email:           document.getElementById('c-email').value.trim(),
        direccion:       document.getElementById('c-direccion').value.trim(),
      };

      try {
        const respuesta = await fetch('/pacientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });

        const json = await respuesta.json();

        if (respuesta.ok) {
          // exito=true, recargar=true -> al cerrar el modal se actualiza la tabla
          mostrarMensaje('Paciente registrado correctamente.', true, true);
          document.getElementById('form-crear').reset();
        } else {
          mostrarMensaje('Error al registrar: ' + (json.detalle || json.error), false, false);
        }
      } catch (error) {
        mostrarMensaje('Error de conexion al intentar registrar el paciente.', false, false);
      }
    }

    //BUSCAR 
    async function buscarPaciente() {
      const cedula = document.getElementById('b-cedula').value.trim();
      const contenedor = document.getElementById('resultado-busqueda');

      if (!cedula) {
        contenedor.innerHTML = '<p style="color:red;">Ingrese una cedula para buscar.</p>';
        return;
      }

      try {
        const respuesta = await fetch('/pacientes/buscar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cedula })
        });

        const json = await respuesta.json();

        if (respuesta.ok) {
          const p = json.data;
          contenedor.innerHTML =
            '<table border="1" cellpadding="6" cellspacing="0">' +
            '<tr><th>Cedula</th><th>Nombre</th><th>Apellido</th><th>Sexo</th><th>Fecha Nacimiento</th><th>Telefono</th><th>Email</th><th>Direccion</th></tr>' +
            '<tr>' +
              '<td>' + (p.cedula    || '-') + '</td>' +
              '<td>' + (p.nombre    || '-') + '</td>' +
              '<td>' + (p.apellido  || '-') + '</td>' +
              '<td>' + (p.sexo      || '-') + '</td>' +
              '<td>' + (p.fechaNacimiento ? new Date(p.fechaNacimiento).toLocaleDateString('es-VE') : '-') + '</td>' +
              '<td>' + (p.telefono  || '-') + '</td>' +
              '<td>' + (p.email     || '-') + '</td>' +
              '<td>' + (p.direccion || '-') + '</td>' +
            '</tr>' +
            '</table>';
        } else {
          contenedor.innerHTML = '<p style="color:red;">' + (json.detalle || json.error) + '</p>';
        }
      } catch (error) {
        contenedor.innerHTML = '<p style="color:red;">Error de conexion al buscar el paciente.</p>';
      }
    }

    //BUSCAR POR ID
    async function buscarPorId() {
      const id = document.getElementById('bid-id').value.trim();
      const contenedor = document.getElementById('resultado-busqueda-id');

      if (!id) {
        contenedor.innerHTML = '<p style="color:red;">Ingrese un ID para buscar.</p>';
        return;
      }

      if (id.length !== 5) {
        contenedor.innerHTML = '<p style="color:red;">El ID debe tener exactamente 5 caracteres.</p>';
        return;
      }

      try {
        const respuesta = await fetch('/pacientes/' + encodeURIComponent(id), {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        const json = await respuesta.json();

        if (respuesta.ok) {
          const p = json.data;
          contenedor.innerHTML =
            '<table border="1" cellpadding="6" cellspacing="0">' +
            '<tr><th>Cedula</th><th>Nombre</th><th>Apellido</th><th>Sexo</th><th>Fecha Nacimiento</th><th>Telefono</th><th>Email</th><th>Direccion</th></tr>' +
            '<tr>' +
              '<td>' + (p.cedula    || '-') + '</td>' +
              '<td>' + (p.nombre    || '-') + '</td>' +
              '<td>' + (p.apellido  || '-') + '</td>' +
              '<td>' + (p.sexo      || '-') + '</td>' +
              '<td>' + (p.fechaNacimiento ? new Date(p.fechaNacimiento).toLocaleDateString('es-VE') : '-') + '</td>' +
              '<td>' + (p.telefono  || '-') + '</td>' +
              '<td>' + (p.email     || '-') + '</td>' +
              '<td>' + (p.direccion || '-') + '</td>' +
            '</tr>' +
            '</table>';
        } else {
          contenedor.innerHTML = '<p style="color:red;">' + (json.detalle || json.error) + '</p>';
        }
      } catch (error) {
        contenedor.innerHTML = '<p style="color:red;">Error de conexion al buscar el paciente.</p>';
      }
    }

    //ACTUALIZAR 
    async function actualizarPaciente() {
      const cedulaActual = document.getElementById('a-cedula-actual').value.trim();

      if (!cedulaActual) {
        mostrarMensaje('Debe indicar la cedula actual del paciente para actualizar.', false, false);
        return;
      }

      const datos = {};
      const cedNueva  = document.getElementById('a-cedula-nueva').value.trim();
      const nombre    = document.getElementById('a-nombre').value.trim();
      const apellido  = document.getElementById('a-apellido').value.trim();
      const sexo      = document.getElementById('a-sexo').value;
      const fecha     = document.getElementById('a-fecha').value;
      const telefono  = document.getElementById('a-telefono').value.trim();
      const email     = document.getElementById('a-email').value.trim();
      const direccion = document.getElementById('a-direccion').value.trim();

      if (cedNueva)  datos.cedula          = cedNueva;
      if (nombre)    datos.nombre          = nombre;
      if (apellido)  datos.apellido        = apellido;
      if (sexo)      datos.sexo            = sexo;
      if (fecha)     datos.fechaNacimiento = fecha;
      if (telefono)  datos.telefono        = telefono;
      if (email)     datos.email           = email;
      if (direccion) datos.direccion       = direccion;

      if (Object.keys(datos).length === 0) {
        mostrarMensaje('Complete al menos un campo para actualizar.', false, false);
        return;
      }

      try {
        const respuesta = await fetch('/pacientes/' + encodeURIComponent(cedulaActual), { //fetch es goodd
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });

        const json = await respuesta.json();

        if (respuesta.ok) {
          mostrarMensaje('Paciente actualizado correctamente.', true, true);
        } else {
          mostrarMensaje('Error al actualizar: ' + (json.detalle || json.error), false, false);
        }
      } catch (error) {
        mostrarMensaje('Error de conexion al intentar actualizar el paciente.', false, false);
      }
    }

    //ELIMINAR 
    async function eliminarPaciente() {
      const cedula = document.getElementById('e-cedula').value.trim();

      if (!cedula) {
        mostrarMensaje('Ingrese la cedula del paciente que desea eliminar.', false, false);
        return;
      }

      const confirmar = confirm('Esta seguro de que desea eliminar al paciente con cedula: ' + cedula + '?');
      if (!confirmar) return;

      try {
        const respuesta = await fetch('/pacientes', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cedula })
        });

        const json = await respuesta.json();

        if (respuesta.ok) {
          mostrarMensaje('Paciente eliminado correctamente.', true, true);
        } else {
          mostrarMensaje('Error al eliminar: ' + (json.detalle || json.error), false, false);
        }
      } catch (error) {
        mostrarMensaje('Error de conexion al intentar eliminar el paciente.', false, false);
      }
    }

  </script>

</body>
</html>
